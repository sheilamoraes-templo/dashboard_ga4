<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard GA4</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Plotly -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .navbar-brand {
            font-weight: bold;
            color: #4285f4 !important;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .card-header {
            background: linear-gradient(135deg, #4285f4, #34a853);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            font-weight: bold;
        }
        
        .metric-card {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-left: 4px solid #4285f4;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #4285f4;
        }
        
        .metric-label {
            color: #6c757d;
            font-size: 0.9rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4285f4, #34a853);
            border: none;
            border-radius: 25px;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #3367d6, #2d8f47);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .insights-box {
            background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
            border-left: 4px solid #34a853;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        .table-responsive {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table th {
            background-color: #4285f4;
            color: white;
            border: none;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line"></i> Dashboard GA4
            </a>
            <div class="navbar-nav ms-auto">
                <button class="btn btn-outline-light btn-sm me-2" onclick="testConnection()">
                    <i class="fas fa-wifi"></i> Testar GA4
                </button>
                <button class="btn btn-outline-light btn-sm me-2" onclick="testSlack()">
                    <i class="fab fa-slack"></i> Testar Slack
                </button>
                <button class="btn btn-outline-light btn-sm" onclick="sendTestEmail()">
                    <i class="fas fa-envelope"></i> Testar Email
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Alertas -->
        <div id="alerts"></div>
        
        <!-- M√©tricas Principais -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-tachometer-alt"></i> M√©tricas Principais
                        <div class="float-end">
                            <select id="periodSelect" class="form-select form-select-sm d-inline-block w-auto" onchange="loadMetrics()">
                                <option value="7">√öltimos 7 dias</option>
                                <option value="30" selected>√öltimos 30 dias</option>
                                <option value="90">√öltimos 90 dias</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="metricsLoading" class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Carregando m√©tricas...
                        </div>
                        <div id="metricsContent" class="row" style="display: none;">
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="metric-card p-3 text-center">
                                    <div class="metric-value" id="totalUsers">-</div>
                                    <div class="metric-label">Usu√°rios</div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="metric-card p-3 text-center">
                                    <div class="metric-value" id="sessions">-</div>
                                    <div class="metric-label">Sess√µes</div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="metric-card p-3 text-center">
                                    <div class="metric-value" id="pageviews">-</div>
                                    <div class="metric-label">Visualiza√ß√µes</div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="metric-card p-3 text-center">
                                    <div class="metric-value" id="avgDuration">-</div>
                                    <div class="metric-label">Dura√ß√£o M√©dia</div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="metric-card p-3 text-center">
                                    <div class="metric-value" id="bounceRate">-</div>
                                    <div class="metric-label">Taxa de Rejei√ß√£o</div>
                                </div>
                            </div>
                            <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
                                <div class="metric-card p-3 text-center">
                                    <div class="metric-value" id="pagesPerSession">-</div>
                                    <div class="metric-label">P√°ginas/Sess√£o</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- P√°ginas Mais Visitadas -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-fire"></i> P√°ginas Mais Visitadas
                    </div>
                    <div class="card-body">
                        <div id="topPagesLoading" class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Carregando p√°ginas...
                        </div>
                        <div id="topPagesContent" style="display: none;">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>P√°gina</th>
                                            <th>Visualiza√ß√µes</th>
                                            <th>Usu√°rios</th>
                                            <th>Dura√ß√£o M√©dia</th>
                                        </tr>
                                    </thead>
                                    <tbody id="topPagesTable">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i> Atividade Di√°ria
                    </div>
                    <div class="card-body">
                        <div id="dailyChartLoading" class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Carregando gr√°fico...
                        </div>
                        <div id="dailyChart"></div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-mobile-alt"></i> Dispositivos
                    </div>
                    <div class="card-body">
                        <div id="deviceChartLoading" class="loading">
                            <i class="fas fa-spinner fa-spin"></i> Carregando dados...
                        </div>
                        <div id="deviceChart"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Automa√ß√£o -->
        <div class="row mb-4">
            <div class="col-lg-4 offset-lg-8">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i> Automa√ß√£o
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="startAutomation()">
                                <i class="fas fa-play"></i> Iniciar Automa√ß√£o
                            </button>
                            <button class="btn btn-warning" onclick="stopAutomation()">
                                <i class="fas fa-stop"></i> Parar Automa√ß√£o
                            </button>
                            <hr>
                            <h6><i class="fab fa-slack"></i> Relat√≥rios Slack</h6>
                            <button class="btn btn-success" onclick="sendSlackReport('daily')">
                                <i class="fab fa-slack"></i> Slack Di√°rio
                            </button>
                            <button class="btn btn-success" onclick="sendSlackReport('weekly')">
                                <i class="fab fa-slack"></i> Slack Semanal
                            </button>
                            <button class="btn btn-success" onclick="sendSlackReport('monthly')">
                                <i class="fab fa-slack"></i> Slack Mensal
                            </button>
                            <hr>
                            <h6><i class="fas fa-envelope"></i> Relat√≥rios Email</h6>
                            <button class="btn btn-info" onclick="sendManualReport('daily')">
                                <i class="fas fa-envelope"></i> Email Di√°rio
                            </button>
                            <button class="btn btn-info" onclick="sendManualReport('weekly')">
                                <i class="fas fa-envelope"></i> Email Semanal
                            </button>
                        </div>
                        <div id="automationStatus" class="mt-3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Fun√ß√µes principais
        function showAlert(message, type = 'info') {
            const alertsDiv = document.getElementById('alerts');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertsDiv.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('pt-BR').format(num);
        }

        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // Carregar m√©tricas
        async function loadMetrics() {
            const period = document.getElementById('periodSelect').value;
            
            document.getElementById('metricsLoading').style.display = 'block';
            document.getElementById('metricsContent').style.display = 'none';
            
            try {
                const response = await fetch(`/api/metrics?days=${period}`);
                const data = await response.json();
                
                if (data.success) {
                    const metrics = data.data;
                    
                    document.getElementById('totalUsers').textContent = formatNumber(parseInt(metrics.totalUsers || 0));
                    document.getElementById('sessions').textContent = formatNumber(parseInt(metrics.sessions || 0));
                    document.getElementById('pageviews').textContent = formatNumber(parseInt(metrics.screenPageViews || 0));
                    document.getElementById('avgDuration').textContent = formatDuration(parseFloat(metrics.averageSessionDuration || 0));
                    document.getElementById('bounceRate').textContent = parseFloat(metrics.bounceRate || 0).toFixed(1) + '%';
                    
                    const pagesPerSession = metrics.screenPageViews && metrics.sessions ? 
                        (parseInt(metrics.screenPageViews) / parseInt(metrics.sessions)).toFixed(1) : '0.0';
                    document.getElementById('pagesPerSession').textContent = pagesPerSession;
                    
                    document.getElementById('metricsLoading').style.display = 'none';
                    document.getElementById('metricsContent').style.display = 'block';
                    
                    // Carregar outros dados
                    loadDailyChart(period);
                    loadDeviceChart(period);
                    loadTopPages(period);
                } else {
                    showAlert('Erro ao carregar m√©tricas: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Erro de conex√£o: ' + error.message, 'danger');
            }
        }

        // Carregar gr√°fico di√°rio
        async function loadDailyChart(period) {
            document.getElementById('dailyChartLoading').style.display = 'block';
            
            try {
                const response = await fetch(`/api/daily-chart?days=${period}`);
                const data = await response.json();
                
                if (data.success) {
                    const chartData = JSON.parse(data.chart);
                    Plotly.newPlot('dailyChart', chartData.data, chartData.layout);
                    document.getElementById('dailyChartLoading').style.display = 'none';
                } else {
                    showAlert('Erro ao carregar gr√°fico: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Erro ao carregar gr√°fico: ' + error.message, 'danger');
            }
        }

        // Carregar gr√°fico de dispositivos
        async function loadDeviceChart(period) {
            document.getElementById('deviceChartLoading').style.display = 'block';
            
            try {
                const response = await fetch(`/api/device-breakdown?days=${period}`);
                const data = await response.json();
                
                if (data.success) {
                    const chartData = JSON.parse(data.chart);
                    Plotly.newPlot('deviceChart', chartData.data, chartData.layout);
                    document.getElementById('deviceChartLoading').style.display = 'none';
                } else {
                    showAlert('Erro ao carregar dados de dispositivos: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Erro ao carregar dados de dispositivos: ' + error.message, 'danger');
            }
        }

        // Carregar p√°ginas mais visitadas
        async function loadTopPages(period) {
            document.getElementById('topPagesLoading').style.display = 'block';
            
            try {
                const response = await fetch(`/api/top-pages?days=${period}&limit=10`);
                const data = await response.json();
                
                if (data.success) {
                    const tableBody = document.getElementById('topPagesTable');
                    tableBody.innerHTML = '';
                    
                    data.data.forEach(page => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td><strong>${page.page_title}</strong><br><small class="text-muted">${page.page_path}</small></td>
                            <td>${formatNumber(page.pageviews)}</td>
                            <td>${formatNumber(page.users)}</td>
                            <td>${formatDuration(page.avg_duration)}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    document.getElementById('topPagesLoading').style.display = 'none';
                    document.getElementById('topPagesContent').style.display = 'block';
                } else {
                    showAlert('Erro ao carregar p√°ginas: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Erro ao carregar p√°ginas: ' + error.message, 'danger');
            }
        }


        // Testar conex√£o
        async function testConnection() {
            try {
                const response = await fetch('/api/test-connection');
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Conex√£o com GA4 estabelecida com sucesso!', 'success');
                } else {
                    showAlert('‚ùå Falha na conex√£o com GA4', 'danger');
                }
            } catch (error) {
                showAlert('Erro ao testar conex√£o: ' + error.message, 'danger');
            }
        }

        // Testar Slack
        async function testSlack() {
            try {
                const response = await fetch('/api/test-slack');
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Conex√£o com Slack estabelecida com sucesso!', 'success');
                } else {
                    showAlert('‚ùå Falha na conex√£o com Slack', 'danger');
                }
            } catch (error) {
                showAlert('Erro ao testar Slack: ' + error.message, 'danger');
            }
        }

        // Testar email
        async function sendTestEmail() {
            try {
                const response = await fetch('/api/send-test-email');
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Email de teste enviado com sucesso!', 'success');
                } else {
                    showAlert('‚ùå Falha ao enviar email de teste', 'danger');
                }
            } catch (error) {
                showAlert('Erro ao enviar email: ' + error.message, 'danger');
            }
        }

        // Automa√ß√£o
        async function startAutomation() {
            try {
                const response = await fetch('/api/automation/start');
                const data = await response.json();
                
                if (data.success) {
                    showAlert('‚úÖ Automa√ß√£o iniciada com sucesso!', 'success');
                    updateAutomationStatus();
                } else {
                    showAlert('‚ùå Falha ao iniciar automa√ß√£o', 'danger');
                }
            } catch (error) {
                showAlert('Erro ao iniciar automa√ß√£o: ' + error.message, 'danger');
            }
        }

        async function stopAutomation() {
            try {
                const response = await fetch('/api/automation/stop');
                const data = await response.json();
                
                if (data.success) {
                    showAlert('üõë Automa√ß√£o parada com sucesso!', 'warning');
                    updateAutomationStatus();
                } else {
                    showAlert('‚ùå Falha ao parar automa√ß√£o', 'danger');
                }
            } catch (error) {
                showAlert('Erro ao parar automa√ß√£o: ' + error.message, 'danger');
            }
        }

        async function updateAutomationStatus() {
            try {
                const response = await fetch('/api/automation/status');
                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    const statusDiv = document.getElementById('automationStatus');
                    
                    if (status.running) {
                        statusDiv.innerHTML = `
                            <div class="alert alert-success">
                                <i class="fas fa-check-circle"></i> Automa√ß√£o ativa
                                <br><small>Jobs: ${status.jobs.join(', ')}</small>
                            </div>
                        `;
                    } else {
                        statusDiv.innerHTML = `
                            <div class="alert alert-secondary">
                                <i class="fas fa-pause-circle"></i> Automa√ß√£o parada
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
            }
        }

        async function sendManualReport(type) {
            try {
                const response = await fetch(`/api/send-report?type=${type}`);
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`‚úÖ Relat√≥rio ${type} enviado com sucesso!`, 'success');
                } else {
                    showAlert(`‚ùå Falha ao enviar relat√≥rio ${type}`, 'danger');
                }
            } catch (error) {
                showAlert('Erro ao enviar relat√≥rio: ' + error.message, 'danger');
            }
        }

        async function sendSlackReport(type) {
            try {
                const response = await fetch(`/api/send-slack-report?type=${type}`);
                const data = await response.json();
                
                if (data.success) {
                    showAlert(`‚úÖ Relat√≥rio ${type} enviado via Slack com sucesso!`, 'success');
                } else {
                    showAlert(`‚ùå Falha ao enviar relat√≥rio ${type} via Slack`, 'danger');
                }
            } catch (error) {
                showAlert('Erro ao enviar relat√≥rio Slack: ' + error.message, 'danger');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            loadMetrics();
            updateAutomationStatus();
        });
    </script>
</body>
</html>
